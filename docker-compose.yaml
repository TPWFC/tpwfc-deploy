services:
  # Frontend - Next.js + Payload CMS
  tpwfc-web:
    image: ghcr.io/tpwfc/tpwfc-web:latest
    container_name: tpwfc-web
    restart: unless-stopped
    volumes:
      - tpwfc-web-db:/app/data/db
      - ./data:/app/data/source:ro
    env_file:
      - .env.client
    healthcheck:
      test: ["CMD", "curl", "-f", "http://tpwfc-web:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - tpwfc-network

  # Backend - Discord Bot + API Server
  tpwfc-discord-server:
    image: ghcr.io/tpwfc/tpwfc-discord-server:latest
    container_name: tpwfc-discord-server
    restart: unless-stopped
    volumes:
      - tpwfc-server-db:/app/data/sqld

      - tpwfc-server-logs:/app/data/logs
    env_file:
      - .env.server
    healthcheck:
      test: ["CMD", "curl", "-f", "http://tpwfc-discord-server:3333/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - tpwfc-network
    depends_on:
      tpwfc-web:
        condition: service_healthy

  # Seeder - One-time data upload after web is ready
  tpwfc-seeder:
    image: ghcr.io/tpwfc/tpwfc-seeder:latest
    container_name: tpwfc-seeder
    restart: "no"
    env_file:
      - .env.worker
    networks:
      - tpwfc-network
    depends_on:
      tpwfc-web:
        condition: service_healthy

  # Cloudflare Tunnel
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: cloudflared
    restart: unless-stopped
    command: tunnel run
    env_file:
      - .env.cloudflare
    networks:
      - tpwfc-network
    depends_on:
      tpwfc-web:
        condition: service_healthy

networks:
  tpwfc-network:
    driver: bridge

volumes:
  tpwfc-web-db:
    driver: local
  tpwfc-server-db:
    driver: local
  tpwfc-server-logs:
    driver: local
