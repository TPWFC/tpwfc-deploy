services:
  # Frontend - Next.js + Payload CMS
  tpwfc-web:
    image: ghcr.io/tpwfc/tpwfc-web:latest
    container_name: tpwfc-web
    restart: unless-stopped
    volumes:
      - tpwfc-web-db:/app/data/db
      - ./data:/app/data/source:ro
    environment:
      - NODE_ENV=production
      - DATABASE_URI=${DATABASE_URI}
      - PAYLOAD_SECRET=${PAYLOAD_SECRET}
      - PAYLOAD_SEED=${PAYLOAD_SEED}
      - ADMIN_EMAIL=${ADMIN_EMAIL}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD}
      - NEXT_PUBLIC_BASE_URL=${NEXT_PUBLIC_BASE_URL}
      - NEXT_PUBLIC_BACKEND_API_URL=${NEXT_PUBLIC_BACKEND_API_URL}
      - NEXT_PUBLIC_TURNSTILE_SITE_KEY=${NEXT_PUBLIC_TURNSTILE_SITE_KEY}
      - SEED_SIGNING_SECRET=${SEED_SIGNING_SECRET}
      - BACKEND_WEBHOOK_SECRET=${BACKEND_WEBHOOK_SECRET}
      - NEXT_PUBLIC_DISCORD_SERVER_URL=${NEXT_PUBLIC_DISCORD_SERVER_URL}
      - NEXT_PUBLIC_DISCORD_FEEDBACK_CHANNEL=${NEXT_PUBLIC_DISCORD_FEEDBACK_CHANNEL}
      - LOG_LEVEL=${LOG_LEVEL}
      - ENABLE_PRETTY_LOGS=${ENABLE_PRETTY_LOGS}
      - GH_TOKEN=${GH_TOKEN}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://tpwfc-web:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - tpwfc-network

  # Backend - Discord Bot + API Server
  tpwfc-discord-server:
    image: ghcr.io/tpwfc/tpwfc-discord-server:latest
    container_name: tpwfc-discord-server
    restart: unless-stopped
    volumes:
      - tpwfc-server-db:/app/.db
      - tpwfc-server-logs:/app/data/logs
    environment:
      - NODE_ENV=production
      - PORT=${PORT:-3333}
      - HOST_NAME=${HOST_NAME:-0.0.0.0}
      - DATABASE_URL=${DATABASE_DISCORD_URL}
      - LOG_LEVEL=${LOG_LEVEL}
      - DISCORD_TOKEN=${DISCORD_TOKEN}
      - DISCORD_CLIENT_ID=${DISCORD_CLIENT_ID}
      - PAYLOAD_API_URL=${PAYLOAD_API_URL}
      - GH_PA_FG_TOKEN=${GH_PA_FG_TOKEN}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://tpwfc-discord-server:3333/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - tpwfc-network
    depends_on:
      tpwfc-web:
        condition: service_healthy

  # Seeder - One-time data upload after web is ready
  tpwfc-seeder:
    image: ghcr.io/tpwfc/tpwfc-seeder:latest
    container_name: tpwfc-seeder
    restart: "no"
    environment:
      - NEXT_PUBLIC_BASE_URL=${NEXT_PUBLIC_BASE_URL:-http://tpwfc-web:3000}
      - HEALTH_TIMEOUT=${HEALTH_TIMEOUT:-120}
      - SEED_SIGNING_SECRET=${SEED_SIGNING_SECRET}
    networks:
      - tpwfc-network
    depends_on:
      tpwfc-web:
        condition: service_healthy

  # Cloudflare Tunnel
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: cloudflared
    restart: unless-stopped
    command: tunnel run
    environment:
      - TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN}
    networks:
      - tpwfc-network
    depends_on:
      tpwfc-web:
        condition: service_healthy

networks:
  tpwfc-network:
    driver: bridge

volumes:
  tpwfc-web-db:
    driver: local
  tpwfc-server-db:
    driver: local
  tpwfc-server-logs:
    driver: local
