services:
  # Frontend - Next.js + Payload CMS
  tpwfc-web:
    image: ghcr.io/tpwfc/tpwfc-web:latest
    container_name: tpwfc-web
    restart: unless-stopped
    volumes:
      - tpwfc-web-db:/app/.db
      - ./data:/app/data:ro
    env_file:
      - .env
    environment:
      - NODE_ENV=production
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - tpwfc-network

  # Backend - Discord Bot + API Server
  tpwfc-discord-server:
    image: ghcr.io/tpwfc/tpwfc-discord-server:latest
    container_name: tpwfc-discord-server
    restart: unless-stopped
    volumes:
      - tpwfc-server-db:/app/.db
      - tpwfc-server-logs:/app/data/logs
    env_file:
      - .env.server
    environment:
      - NODE_ENV=production
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3333/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - tpwfc-network
    depends_on:
      tpwfc-web:
        condition: service_healthy

  # Seeder - One-time data upload after web is ready
  tpwfc-seeder:
    image: ghcr.io/tpwfc/tpwfc-seeder:latest
    container_name: tpwfc-seeder
    restart: "no"
    env_file:
      - .env.seeder
    environment:
      - WEB_URL=http://tpwfc-web:3000
      - HEALTH_TIMEOUT=120
    networks:
      - tpwfc-network
    depends_on:
      tpwfc-web:
        condition: service_healthy

  # Cloudflare Tunnel
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: cloudflared
    restart: unless-stopped
    command: tunnel run
    environment:
      - TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN}
    networks:
      - tpwfc-network
    depends_on:
      tpwfc-web:
        condition: service_healthy

networks:
  tpwfc-network:
    driver: bridge

volumes:
  tpwfc-web-db:
    driver: local
  tpwfc-server-db:
    driver: local
  tpwfc-server-logs:
    driver: local
